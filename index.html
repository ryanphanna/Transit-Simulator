<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transit Simulator – Tutorial City v0.8</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style> html, body { height: 100%; background: #f8fafc; } </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-presets="env,react">
    const { useEffect, useMemo, useState, useRef } = React;

    // ===== Config =====
    const GRID = 20, CELL_SIZE = 24, CANVAS_SIZE = GRID*CELL_SIZE;

    // City & growth
    const START_POP = 100_000;
    const POP_GROWTH_PER_YEAR = 5_000; // +5k/year
    const MODE_SHARE_TARGET = 5; // %
    const MODE_SHARE_STREAK_DAYS = 30; // hold for 30 days to graduate

    // Service hours (player adjustable)
    const DEFAULT_SERVICE_START_HOUR = 6; // 6:00
    const DEFAULT_SERVICE_END_HOUR   = 22; // 22:00

    // Economics
    const STARTING_CASH = 5_000_000;
    const STOP_CAPEX = 15_000;
    const DRIVER_WAGE_PER_HOUR = 60;   // wages+benefits
    const OVERHEAD_PER_VEH_HOUR = 60;  // base non-staff overhead

    // Speed & capacity
    const VEHICLE_SPEED_BASE = 25; // km/h
    const SEATED_CAP = 40, STANDING_CAP = 25, CRUSH_EXTRA = 10;
    const VEHICLE_CAPACITY = SEATED_CAP + STANDING_CAP + CRUSH_EXTRA; // 75

    // Fleet & depot
    const INITIAL_FLEET = 10;
    const DEPOT_BASE_CAPACITY = 25;
    const DEPOT_EXPANSION_STEP = 50;
    const DEPOT_EXPANSION_COST = 8_000_000;
    const TURNAROUND_MIN = 6;

    // Fuels
    const FUELS = {
      Diesel: { busCost: 550_000, costPerKm: 1.10, emissions: 1.0 },
      CNG:    { busCost: 600_000, costPerKm: 0.90, emissions: 0.7 },
      BEV:    { busCost: 900_000, costPerKm: 0.50, emissions: 0.2 },
    };

    // Maintenance
    const BASE_MAINT_PER_BUS_YEAR = 35_000;
    const maintMultiplier = (age)=> age<=5? 1 : 1 + 0.05*(age-5);

    // Drivers & shifts
    const INITIAL_DRIVERS = 20;
    const SHIFT_HOURS = 8;
    const OVERTIME_MULT = 1.5;

    // Demand & behavior (slightly easier)
    const BASE_DEMAND_PER_CELL_PER_HOUR = 11.5; // +15% vs v0.6
    const JOB_ATTRACTION_PER_CELL = 10;
    const COVERAGE_RADIUS = 3;
    const WALK_DECAY = 0.35;
    const TARGET_STOP_SPACING_CELLS = 3; // ~300m
    const FARE_REF = 2.0;
    const FARE_ELASTICITY = -0.25;
    const WAIT_TIME_SENSITIVITY = 0.06;

    // Subsidy – per-boarding + small residual gap share
    const SUBSIDY_PER_BOARDING = 1.00;  // $ per boarding (tutorial simplification)
    const RESIDUAL_GAP_SHARE = 0.2;     // 20% of remaining gap

    // Time
    const SIM_MINUTES_PER_TICK = 1;
    const TICK_MS = 600;

    // POIs / Destinations
    const AIRPORT_POP_THRESHOLD = 150_000; // configurable
    const POI_TYPES = [
      { key:'retail',   label:'Retail',   icon:'🛍️', jobsBoost: 1.0 },
      { key:'school',   label:'School',   icon:'🏫', jobsBoost: 0.8 },
      { key:'tourism',  label:'Tourism',  icon:'🎡', jobsBoost: 1.2 },
      { key:'airport',  label:'Airport',  icon:'✈️', jobsBoost: 2.0 },
    ];

    // ===== Utils =====
    const distance = (a,b)=> Math.hypot(a.x-b.x, a.y-b.y);
    const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
    function mulberry32(a){ return function(){ let t=(a+=0x6D2B79F5); t=Math.imul(t^(t>>>15), t|1); t^= t + Math.imul(t^(t>>>7), t|61); return ((t^(t>>>14))>>>0)/4294967296; } }

    function generateLandUse(seed){
      const rngPop = mulberry32(seed*101), rngJobs = mulberry32(seed*701);
      const pop = Array.from({length:GRID}, ()=> Array(GRID).fill(0));
      const jobs= Array.from({length:GRID}, ()=> Array(GRID).fill(0));
      for(let y=0;y<GRID;y++) for(let x=0;x<GRID;x++){
        const a=rngPop(), b=rngPop();
        const cx=(x-GRID/2)/(GRID/2), cy=(y-GRID/2)/(GRID/2);
        const centerBias=Math.exp(-(cx*cx+cy*cy)*1.2);
        pop[y][x] = Math.floor(Math.min(3.2, (a*0.6+b*0.4)*0.5 + 0.5*centerBias) * 3.2);
        const aj=rngJobs(), bj=rngJobs();
        const ringBias = Math.exp(-Math.pow(((cx*cx+cy*cy)-0.25),2) * 2);
        jobs[y][x]= Math.floor(Math.min(3.2, (aj*0.5+bj*0.5)*0.5 + 0.5*ringBias) * 3.2);
      }
      return { pop, jobs };
    }

    function generatePOIs(seed, population){
      const rng = mulberry32(seed*999);
      const count = Math.round(GRID*GRID*0.08); // ~8% tiles get POIs
      const poiMap = new Map();
      const downtown = { x: Math.floor(GRID/2), y: Math.floor(GRID/2) };
      const sat1 = { x: Math.floor(GRID*0.25), y: Math.floor(GRID*0.3) };
      const sat2 = { x: Math.floor(GRID*0.75), y: Math.floor(GRID*0.7) };

      function placeNear(center, share){
        const n = Math.round(count*share);
        for(let i=0;i<n;i++){
          // Gaussian-ish scatter
          const dx = Math.round((rng()-0.5)*6), dy = Math.round((rng()-0.5)*6);
          const x = clamp(center.x+dx, 0, GRID-1), y = clamp(center.y+dy, 0, GRID-1);
          const key = `${x},${y}`;
          if(!poiMap.has(key)) poiMap.set(key, pickPoiType(rng, population));
        }
      }

      function placeRandom(share){
        const n = Math.round(count*share);
        for(let i=0;i<n;i++){
          const x = Math.floor(rng()*GRID), y = Math.floor(rng()*GRID);
          const key = `${x},${y}`;
          if(!poiMap.has(key)) poiMap.set(key, pickPoiType(rng, population));
        }
      }

      // 60% downtown cluster, 20% satellites, 20% random
      placeNear(downtown, 0.6);
      placeNear(sat1, 0.1);
      placeNear(sat2, 0.1);
      placeRandom(0.2);

      // Optional airport near an edge
      if(population >= AIRPORT_POP_THRESHOLD){
        const edge = rng() < 0.5 ? { x: GRID-2, y: Math.floor(GRID*0.2) } : { x: 1, y: Math.floor(GRID*0.8) };
        poiMap.set(`${edge.x},${edge.y}`, 'airport');
      }

      return poiMap; // Map key-> poi key
    }

    function pickPoiType(rng, population){
      // Basic mix; could weight by population later.
      const r = rng();
      if(r < 0.45) return 'retail';
      if(r < 0.65) return 'school';
      if(r < 0.90) return 'tourism';
      return 'retail';
    }

    function poiIcon(key){ return POI_TYPES.find(p=> p.key===key)?.icon || ''; }
    function poiJobsBoost(key){ return POI_TYPES.find(p=> p.key===key)?.jobsBoost || 0; }

    function polylineLengthKm(points){ if(points.length<2) return 0; let s=0; for(let i=1;i<points.length;i++) s+=distance(points[i-1],points[i]); return s*0.1; }

    // ===== Small Notification system (top-right status banners) =====
    const BANNER_DURATIONS = { info: 10000, success: 10000, warn: 10000, celebrate: 10000 }; // 10s
    function Banner({ banner, onClose }){
      const color = banner.type==='success'? 'bg-emerald-50 border-emerald-300 text-emerald-900'
                  : banner.type==='warn'? 'bg-amber-50 border-amber-300 text-amber-900'
                  : banner.type==='celebrate'? 'bg-violet-50 border-violet-300 text-violet-900'
                  : 'bg-sky-50 border-sky-300 text-sky-900';
      return (
        <div className={`w-80 rounded-xl border p-3 shadow-sm ${color} animate-[fadein_150ms_ease-out]`}>
          <div className="flex items-start gap-2">
            <div className="text-sm leading-snug flex-1">{banner.text}</div>
            <button className="text-xs px-2 py-0.5 rounded border border-slate-300/70 hover:bg-white/40" onClick={onClose}>✕</button>
          </div>
        </div>
      );
    }

    function useBanners(){
      const [queue, setQueue] = useState([]); // one at a time
      useEffect(()=>{
        if(queue.length===0) return; // nothing showing
        const b = queue[0];
        const t = setTimeout(()=> setQueue([]), BANNER_DURATIONS[b.type] || 3500);
        return ()=> clearTimeout(t);
      }, [queue]);
      const show = (banner)=> setQueue([banner]);
      const dismiss = ()=> setQueue([]);
      const view = (
        <div className="fixed top-4 right-4 z-50 space-y-2">
          {queue.map((b,i)=> <Banner key={i} banner={b} onClose={dismiss} />)}
        </div>
      );
      return { show, view };
    }

    function App(){
      // ==== land use & UI state
      const [seed,setSeed]=useState(42);
      const [population,setPopulation]=useState(START_POP);
      const [poiMap,setPoiMap]=useState(()=> generatePOIs(42, START_POP));
      const land=useMemo(()=> generateLandUse(seed),[seed]);
      useEffect(()=>{ setPoiMap(generatePOIs(seed, population)); }, [seed, population]);

      const [stops,setStops]=useState([]);
      const [fare,setFare]=useState(2.0);
      const [targetVehPerHour,setTargetVehPerHour]=useState(6);
      const [running,setRunning]=useState(false);
      const [cash,setCash]=useState(STARTING_CASH);
      const [ridershipHour,setRidershipHour]=useState(0);
      const [loadFactor,setLoadFactor]=useState(0);

      // fleet / depot / fuel / aging
      const [fleet,setFleet]=useState(INITIAL_FLEET);
      const [avgBusAge,setAvgBusAge]=useState(3);
      const [depotCapacity,setDepotCapacity]=useState(DEPOT_BASE_CAPACITY);
      const [fuel,setFuel]=useState('Diesel');

      // staff & time
      const [drivers,setDrivers]=useState(INITIAL_DRIVERS);
      const [dayMinutes,setDayMinutes]=useState(0);
      const [totalMinutes,setTotalMinutes]=useState(0);
      const [dayVehHours,setDayVehHours]=useState(0);
      const [serviceStartHour,setServiceStartHour]=useState(DEFAULT_SERVICE_START_HOUR);
      const [serviceEndHour,setServiceEndHour]=useState(DEFAULT_SERVICE_END_HOUR);

      // graduation
      const [modeShare,setModeShare]=useState(0);
      const [streakDays,setStreakDays]=useState(0);
      const [graduated,setGraduated]=useState(false);

      // tutorial banners
      const [tutorialStep,setTutorialStep]=useState(0);
      const banners = useBanners();

      const [effSpeed,setEffSpeed]=useState(VEHICLE_SPEED_BASE);

      const lineKm = useMemo(()=> polylineLengthKm(stops), [stops]);
      const cycleTimeHours = useMemo(()=>{
        const runTimeH = lineKm / Math.max(5, effSpeed);
        return Math.max(0.05, runTimeH*2 + TURNAROUND_MIN/60);
      }, [lineKm, effSpeed]);

      const maxBusesInService = Math.floor(Math.min(fleet, depotCapacity));
      const maxVehPerHourThroughput = maxBusesInService>0 ? (maxBusesInService / cycleTimeHours) : 0;
      const actualVehPerHour = Math.min(targetVehPerHour, Math.floor(maxVehPerHourThroughput));
      const capacityPerHour = actualVehPerHour * VEHICLE_CAPACITY;
      const avgWait = actualVehPerHour>0 ? (60/actualVehPerHour)/2 : Infinity;

      // service window
      const serviceStartMin = serviceStartHour*60;
      const serviceEndMin = serviceEndHour*60;
      const withinService = dayMinutes >= serviceStartMin && dayMinutes < serviceEndMin;
      const serviceHoursToday = Math.max(0, serviceEndHour - serviceStartHour);

      // spacing efficiency
      const spacingEff = useMemo(()=>{
        if(stops.length<2) return 0.6;
        let sum=0,n=0; for(let i=1;i<stops.length;i++){ sum += Math.abs(stops[i-1].x-stops[i].x)+Math.abs(stops[i-1].y-stops[i].y); n++; }
        const avg=sum/n; const ratio = Math.min(avg, TARGET_STOP_SPACING_CELLS)/Math.max(avg, TARGET_STOP_SPACING_CELLS);
        return 0.6 + 0.4*ratio;
      }, [stops]);

      // demand potential (now with POIs boosting jobs)
      const demandPotentialPerHour = useMemo(()=>{
        if(stops.length===0) return 0;
        const distMap=new Map();
        for(const s of stops){
          for(let dy=-COVERAGE_RADIUS;dy<=COVERAGE_RADIUS;dy++){
            for(let dx=-COVERAGE_RADIUS;dx<=COVERAGE_RADIUS;dx++){
              const nx=s.x+dx, ny=s.y+dy; if(nx<0||ny<0||nx>=GRID||ny>=GRID) continue;
              const d=Math.abs(dx)+Math.abs(dy); if(d>COVERAGE_RADIUS) continue;
              const key=`${nx},${ny}`; const prev=distMap.get(key);
              distMap.set(key, prev==null? d : Math.min(prev,d));
            }
          }
        }
        let popSum=0, jobsSum=0, poiBoostSum=0;
        distMap.forEach((dist, key)=>{
          const [x,y]=key.split(',').map(Number);
          const w = Math.exp(-WALK_DECAY * dist);
          popSum += land.pop[y][x] * w;
          jobsSum += land.jobs[y][x] * w;
          const poi = poiMap.get(key);
          if(poi){ poiBoostSum += poiJobsBoost(poi) * w; }
        });
        const popScale = population / START_POP;
        // POI boost increases effective jobs attraction
        const jobsEff = (jobsSum * JOB_ATTRACTION_PER_CELL) + (poiBoostSum*5);
        return (popSum * BASE_DEMAND_PER_CELL_PER_HOUR) * Math.pow(jobsEff,0.5) * spacingEff * popScale;
      }, [stops, land, spacingEff, population, poiMap]);

      // build & manage
      function handleCellClick(x,y){ if(running){ banners.show({ type:'info', text:'Pause to edit route — click Pause to add stops.'}); return; } setStops(prev=>{ if(prev.some(p=>p.x===x&&p.y===y)) return prev; const next=[...prev,{x,y}]; setCash(c=> c-STOP_CAPEX); if(tutorialStep===0 && next.length>=1) setTutorialStep(1); if(tutorialStep===1 && next.length>=3) setTutorialStep(2); return next; }); }
      function buyBuses(n){ const unit=FUELS[fuel].busCost; const disc=n>=10?0.10:n>=5?0.05:0; const total=Math.round(unit*n*(1-disc)); if(running||cash<total) return; setCash(c=>c-total); setFleet(f=>f+n); setAvgBusAge(a=> (a*fleet)/(fleet+n)); }
      function expandDepot(){ if(running||cash<DEPOT_EXPANSION_COST) return; setCash(c=>c-DEPOT_EXPANSION_COST); setDepotCapacity(cap=>cap+DEPOT_EXPANSION_STEP); }
      function hireDrivers(n){ if(running) return; setDrivers(d=> Math.max(0,d+n)); }

      // staffing (non-driver roles)
      const staffing = useMemo(()=>{
        const driversCount = drivers;
        const mechanics = Math.ceil(fleet/5);
        const supervisors = Math.ceil(Math.max(1, driversCount)/12);
        const gm = 1;
        const baseAdmin = 5;
        const totalCore = driversCount + mechanics + supervisors + gm + baseAdmin;
        const extraAdmin = Math.floor(totalCore/50);
        const admin = baseAdmin + extraAdmin;
        const annualCost = (driversCount*70_000 + supervisors*90_000 + mechanics*85_000 + admin*80_000 + gm*120_000);
        const perMinute = annualCost / 525_600;
        return { drivers: driversCount, mechanics, supervisors, admin, gm, annualCost, perMinute, total: driversCount+mechanics+supervisors+admin+gm };
      }, [drivers, fleet]);

      // sim tick
      useEffect(()=>{
        if(!running) return; const id=setInterval(()=>{
          const priceFactor = Math.pow(Math.max(0.5, Math.min(5, fare))/FARE_REF, FARE_ELASTICITY);
          const waitFactor = Math.exp(-WAIT_TIME_SENSITIVITY * (isFinite(avgWait)? avgWait : 60));
          const demand = (withinService ? demandPotentialPerHour : 0) * priceFactor * waitFactor;
          const servedPerHour = Math.min(demand, capacityPerHour);
          const lf = capacityPerHour>0 ? servedPerHour/capacityPerHour : 0;
          const nextSpeed = VEHICLE_SPEED_BASE * (1 - 0.25 * Math.max(0, lf-0.8));

          const revenuePerMinute = (withinService ? (servedPerHour * fare) / 60 : 0);
          const driversDailyCapacity = drivers * SHIFT_HOURS;
          const addVehHours = (withinService ? (actualVehPerHour / 60) * SIM_MINUTES_PER_TICK : 0);
          const newDayVehHours = dayVehHours + addVehHours;
          const overtime = newDayVehHours > driversDailyCapacity;
          const wageRate = DRIVER_WAGE_PER_HOUR * (overtime? OVERTIME_MULT:1);
          const costPerKm = FUELS[fuel].costPerKm * maintMultiplier(avgBusAge);
          const hourlyMaint = (fleet * (BASE_MAINT_PER_BUS_YEAR * maintMultiplier(avgBusAge))) / (365*24);
          const opCostPerHour = (withinService ? (actualVehPerHour * (wageRate + OVERHEAD_PER_VEH_HOUR) + actualVehPerHour * (nextSpeed * costPerKm)) : 0) + hourlyMaint;
          const opCostPerMinute = opCostPerHour/60 + staffing.perMinute;
          const subsidyBoardingPerMinute = (withinService ? (servedPerHour * SUBSIDY_PER_BOARDING) / 60 : 0);
          const gapPerMinute = Math.max(0, opCostPerMinute - revenuePerMinute - subsidyBoardingPerMinute);
          const subsidyResidualPerMinute = gapPerMinute * RESIDUAL_GAP_SHARE;
          const totalSubsidyPerMinute = subsidyBoardingPerMinute + subsidyResidualPerMinute;

          setCash(c=> c + (revenuePerMinute - opCostPerMinute + totalSubsidyPerMinute) * SIM_MINUTES_PER_TICK);
          setRidershipHour(withinService ? servedPerHour : 0);
          setLoadFactor(lf);
          setEffSpeed(nextSpeed);

          const nm = dayMinutes + SIM_MINUTES_PER_TICK;
          const tm = totalMinutes + SIM_MINUTES_PER_TICK;
          const dayRollover = nm >= 1440;
          setDayMinutes(dayRollover? 0 : nm);
          setTotalMinutes(tm);
          setDayVehHours(dayRollover? addVehHours : newDayVehHours);

          if(dayRollover){
            const dailyRiders = servedPerHour * serviceHoursToday; // approx
            const ms = (population>0 ? (dailyRiders / population) * 100 : 0);
            setModeShare(ms);
            const meets = ms >= MODE_SHARE_TARGET;
            setStreakDays(s=> meets? s+1 : 0);
            if(!graduated && meets && (streakDays+1) >= MODE_SHARE_STREAK_DAYS){ setGraduated(true); setCash(c=> c + 500_000); banners.show({ type:'celebrate', text:`🎓 You graduated Tutorial City! Mode share ≥ ${MODE_SHARE_TARGET}% for ${MODE_SHARE_STREAK_DAYS} days (+$500k).`}); }
            const yearsPassed = Math.floor((tm)/525_600);
            setPopulation(START_POP + yearsPassed*POP_GROWTH_PER_YEAR);
          }
        }, TICK_MS); return ()=> clearInterval(id);
      }, [running, fare, avgWait, capacityPerHour, demandPotentialPerHour, actualVehPerHour, fuel, avgBusAge, drivers, dayVehHours, dayMinutes, totalMinutes, population, graduated, streakDays, serviceStartHour, serviceEndHour]);

      // milestone & advisory banners
      const lastMilestoneRef = useRef(0);
      useEffect(()=>{
        const ms = modeShare;
        const milestones = [1,2,3,5];
        for(const m of milestones){
          if(ms >= m && lastMilestoneRef.current < m){
            lastMilestoneRef.current = m;
            const text = m===5? `🎉 Ridership milestone: ${m}% mode share!`
                               : `Ridership milestone reached — ${m}% of residents ride daily!`;
            banners.show({ type: m===5? 'celebrate':'success', text });
          }
        }
      }, [modeShare]);
      useEffect(()=>{ if(cash < 250_000) banners.show({ type:'warn', text:'Agency funds are low. Consider raising fares or reducing service.'}); }, [cash]);
      useEffect(()=>{ if(loadFactor>0.9) banners.show({ type:'info', text:'Buses are overcrowded — add buses or increase frequency.'}); }, [loadFactor]);
      useEffect(()=>{
        if(actualVehPerHour < targetVehPerHour){
          const need = Math.ceil(targetVehPerHour * cycleTimeHours);
          const reasons=[];
          if(need>fleet) reasons.push('fleet');
          if(need>depotCapacity) reasons.push('depot');
          const drvNeed = targetVehPerHour * serviceHoursToday;
          if(drvNeed > drivers*SHIFT_HOURS) reasons.push('drivers');
          const maxThrough = Math.floor(maxVehPerHourThroughput);
          if(maxThrough < targetVehPerHour) reasons.push('cycle time');
          if(reasons.length) banners.show({ type:'info', text:`Actual < Target frequency — limiting factor: ${reasons[0]}.`});
        }
      }, [actualVehPerHour, targetVehPerHour, fleet, depotCapacity, drivers, cycleTimeHours, serviceHoursToday, maxVehPerHourThroughput]);

      const polyline = useMemo(()=> stops.length<2? "" : stops.map(p=> `${p.x*CELL_SIZE + CELL_SIZE/2},${p.y*CELL_SIZE + CELL_SIZE/2}`).join(" "), [stops]);
      const fmtMoney = (v)=> v.toLocaleString(undefined,{style:'currency', currency:'USD', maximumFractionDigits:0});

      // tutorial text (soft)
      const tutorialText = [
        `Welcome to Tutorial City (pop. ${population.toLocaleString()}). Click the map to place stops.`,
        `Place at least 3 stops to define your first route.`,
        `Set your Target Frequency (try 4+ veh/hr).`,
        `Buy buses / hire drivers if Actual < Target.`,
        `Hit ▶ Play to start service.`,
        `Goal: Reach ${MODE_SHARE_TARGET}% mode share for ${MODE_SHARE_STREAK_DAYS} days to graduate.`
      ][tutorialStep] || `Goal: Reach ${MODE_SHARE_TARGET}% mode share for ${MODE_SHARE_STREAK_DAYS} days to graduate.`;
      useEffect(()=>{
        if(tutorialStep===0 && stops.length>=1) setTutorialStep(1);
        if(tutorialStep===1 && stops.length>=3) setTutorialStep(2);
        if(tutorialStep===2 && targetVehPerHour>=4) setTutorialStep(3);
        if(tutorialStep===3 && fleet>=4 && drivers>=10) setTutorialStep(4);
        if(tutorialStep===4 && running) setTutorialStep(5);
      }, [tutorialStep, stops.length, targetVehPerHour, fleet, drivers, running]);

      // ===== Desktop layout: centered map, panels on the right =====
      return (
        <div className="min-h-screen w-full text-slate-900 flex flex-col items-center py-6">
          {/* Notifications */}
          {banners.view}

          <h1 className="text-2xl font-semibold tracking-tight">Transit Simulator – Tutorial City</h1>
          <p className="text-sm text-slate-600">Population {population.toLocaleString()} • Goal: {MODE_SHARE_TARGET}% mode share for {MODE_SHARE_STREAK_DAYS} days</p>

          {/* Soft tutorial banner */}
          <div className="mt-3 max-w-3xl w-full">
            <div className="rounded-xl bg-white border border-sky-200 p-3 text-sky-900 shadow-sm flex items-start gap-2">
              <div className="w-2 h-2 rounded-full bg-sky-500 mt-2"></div>
              <div className="text-sm">{tutorialText}</div>
              <button className="ml-auto text-xs px-2 py-1 rounded border border-slate-300 hover:bg-slate-100" onClick={()=> setTutorialStep(s=> Math.min(s+1,5))}>Next</button>
            </div>
          </div>

          <div className="mt-4 grid gap-4 grid-cols-1 lg:grid-cols-[auto_520px]">
            {/* Map */}
            <div className="relative rounded-2xl overflow-hidden border border-slate-200 bg-white shadow-sm" style={{ width: CANVAS_SIZE, height: CANVAS_SIZE }}>
              <div className="absolute inset-0">
                {Array.from({length:GRID}).map((_,y)=> (
                  <div key={y} className="flex">
                    {Array.from({length:GRID}).map((__,x)=>{
                      const p = land.pop[y][x];
                      const jb = land.jobs[y][x];
                      const poi = poiMap.get(`${x},${y}`);
                      const bg = p===0? '#EFF6FF' : p===1? '#DBEAFE' : p===2? '#BFDBFE' : '#93C5FD';
                      const outline = jb>0 ? '1px solid rgba(234,179,8,0.25)' : '1px solid rgba(2,6,23,0.06)';
                      return (
                        <div key={`${x}-${y}`} onClick={()=> handleCellClick(x,y)} style={{ width: CELL_SIZE, height: CELL_SIZE, backgroundColor: bg, outline, cursor:'crosshair', position:'relative' }}>
                          {poi && <div style={{position:'absolute', inset:'0', display:'grid', placeItems:'center', fontSize:'12px'}}>{poiIcon(poi)}</div>}
                        </div>
                      );
                    })}
                  </div>
                ))}
              </div>
              <svg className=\"absolute inset-0\" width={CANVAS_SIZE} height={CANVAS_SIZE} style={{ pointerEvents: 'none' }}>
                {stops.length>=2 && <polyline points={stops.map(p=> `${p.x*CELL_SIZE + CELL_SIZE/2},${p.y*CELL_SIZE + CELL_SIZE/2}`).join(' ')} fill="none" stroke="#0ea5e9" strokeWidth={4} strokeLinejoin="round" strokeLinecap="round" />}
              </svg>
              {stops.map((p,i)=> (
                <div key={i} className="absolute -translate-x-1/2 -translate-y-1/2" style={{ left: p.x*CELL_SIZE + CELL_SIZE/2, top: p.y*CELL_SIZE + CELL_SIZE/2 }}>
                  <div className="w-3.5 h-3.5 rounded-full border border-sky-400 bg-sky-500" />
                </div>
              ))}
            </div>

            {/* Panels */}
            <div className="flex flex-col gap-4">
              {/* HUD + Progress */}
              <div className="rounded-2xl bg-white border border-slate-200 p-4 shadow-sm">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="text-xs uppercase text-slate-500">Cash</div>
                    <div className={`text-xl font-semibold ${cash<0? 'text-rose-600':'text-emerald-600'}`}>{fmtMoney(cash)}</div>
                  </div>
                  <div className="text-right">
                    <div className="text-xs uppercase text-slate-500">Riders</div>
                    <div className="text-xl font-semibold">{Math.round(ridershipHour).toLocaleString()} / hr</div>
                  </div>
                </div>
                <div className="mt-2 grid grid-cols-3 gap-2 text-xs text-slate-600">
                  <div>Target: {targetVehPerHour} veh/hr</div>
                  <div>Actual: {actualVehPerHour} veh/hr</div>
                  <div>Cycle: {(cycleTimeHours*60).toFixed(0)} min</div>
                </div>
                {/* Mode-share progress bar */}
                <div className="mt-3">
                  <div className="flex justify-between text-xs text-slate-600">
                    <span>Transit mode share</span>
                    <span>{modeShare.toFixed(2)}% / {MODE_SHARE_TARGET}%</span>
                  </div>
                  <div className="h-2 rounded-full bg-slate-200 overflow-hidden mt-1">
                    <div className="h-full bg-sky-500" style={{ width: `${Math.min(100, (modeShare/MODE_SHARE_TARGET)*100)}%` }}></div>
                  </div>
                </div>
              </div>

              {/* Controls */}
              <div className="rounded-2xl bg-white border border-slate-200 p-4 shadow-sm flex flex-col gap-4">
                <label className="text-sm"><span className="block text-slate-700 mb-1">{`Fare: $${fare.toFixed(2)} ($1.50–$3.00)`}</span><input type="range" min={1.5} max={3.0} step={0.05} value={fare} onChange={(e)=> setFare(parseFloat(e.target.value))} className="w-full" /></label>
                <label className="text-sm"><span className="block text-slate-700 mb-1">Target Frequency (2–20 veh/hr)</span><input type="range" min={2} max={20} step={1} value={targetVehPerHour} onChange={(e)=> setTargetVehPerHour(parseInt(e.target.value))} className="w-full" /></label>

                <div className="grid grid-cols-2 gap-3">
                  <div className="rounded-xl bg-slate-50 border border-slate-200 p-3">
                    <div className="text-sm font-medium text-slate-900">Fleet & Depot</div>
                    <div className="text-xs text-slate-600 mt-1">Buses: <span className="text-slate-900 font-semibold">{fleet}</span> | Depot cap: <span className="text-slate-900 font-semibold">{depotCapacity}</span></div>
                    <div className="text-xs text-slate-600">Max throughput: <span className="text-slate-900 font-semibold">{Math.floor(maxVehPerHourThroughput)}</span> veh/hr</div>
                    <div className="mt-2 flex gap-2 flex-wrap">
                      <button onClick={()=> buyBuses(1)} className="px-2 py-1 rounded-lg text-xs bg-white border border-slate-300 hover:bg-slate-100">Buy 1 ({FUELS[fuel].busCost.toLocaleString()})</button>
                      <button onClick={()=> buyBuses(5)} className="px-2 py-1 rounded-lg text-xs bg-white border border-slate-300 hover:bg-slate-100">Buy 5 (−5%)</button>
                      <button onClick={()=> buyBuses(10)} className="px-2 py-1 rounded-lg text-xs bg-white border border-slate-300 hover:bg-slate-100">Buy 10 (−10%)</button>
                      <button onClick={expandDepot} className="px-2 py-1 rounded-lg text-xs bg-white border border-slate-300 hover:bg-slate-100">Expand Depot +{DEPOT_EXPANSION_STEP} ({DEPOT_EXPANSION_COST.toLocaleString()})</button>
                    </div>
                    <div className="text-xs text-slate-600 mt-2">Avg bus age: <span className="text-slate-900 font-semibold">{avgBusAge.toFixed(1)}</span> yrs</div>
                  </div>

                  <div className="rounded-xl bg-slate-50 border border-slate-200 p-3">
                    <div className="text-sm font-medium text-slate-900">Fuel, Drivers, Subsidy & Staff</div>
                    <div className="flex gap-2 mt-2 text-xs">
                      {Object.keys(FUELS).map(k=> (
                        <button key={k} onClick={()=> setFuel(k)} className={`px-2 py-1 rounded-lg border ${fuel===k? 'bg-sky-100 border-sky-300' : 'bg-white border-slate-300 hover:bg-slate-100'}`}>{k}</button>
                      ))}
                    </div>
                    <div className="text-xs text-slate-600 mt-2">$ / km: <span className="text-slate-900 font-semibold">{FUELS[fuel].costPerKm.toFixed(2)}</span> • Maint ×{maintMultiplier(avgBusAge).toFixed(2)}</div>
                    <div className="text-xs text-slate-600">Drivers: <span className="text-slate-900 font-semibold">{drivers}</span> (cap {drivers*SHIFT_HOURS} drv-hrs/day)
                      <button onClick={()=> hireDrivers(+10)} className="ml-2 px-2 py-0.5 rounded bg-white border border-slate-300 hover:bg-slate-100">+10</button>
                      <button onClick={()=> hireDrivers(-10)} className="ml-1 px-2 py-0.5 rounded bg-white border border-slate-300 hover:bg-slate-100">−10</button>
                    </div>
                    <div className="text-xs text-slate-600">Subsidy per boarding: <span className="text-slate-900 font-semibold">${SUBSIDY_PER_BOARDING.toFixed(2)}</span> (+ <span className="text-slate-900 font-semibold">{Math.round(RESIDUAL_GAP_SHARE*100)}%</span> residual of gap)</div>
                    <div className="text-xs text-slate-600">Staff: D {staffing.drivers} • Sup {staffing.supervisors} • Mech {staffing.mechanics} • Admin {staffing.admin} • GM {staffing.gm} (annual {Math.round(staffing.annualCost/1000).toLocaleString()}k)</div>
                  </div>
                </div>

                <div className="rounded-2xl bg-slate-50 border border-slate-200 p-3 text-xs text-slate-700">
                  <div className="text-sm font-medium text-slate-900 mb-1">Stop Placement, Service, Demand</div>
                  <p>Catchments use distance-decay; demand ≈ Pop × (Jobs + POIs)^0.5 × spacing efficiency × fare & wait factors. Population grows +5,000/year.</p>
                  <p className="mt-1">Service hours: choose when buses run. More hours increase ridership <strong>and</strong> labor/fuel cost. Only minutes inside your service window generate riders and driver-hours.</p>
                </div>

                <div className="rounded-2xl bg-slate-50 border border-slate-200 p-3 text-xs text-slate-700">
                  <div className="text-sm font-medium text-slate-900 mb-1">Service Hours</div>
                  <div className="grid grid-cols-2 gap-3">
                    <label>Start: <input type="number" min="0" max="23" value={serviceStartHour} onChange={(e)=> setServiceStartHour(clamp(parseInt(e.target.value)||0,0,23))} className="ml-1 w-16 border border-slate-300 rounded px-1"/>:00</label>
                    <label>End: <input type="number" min="1" max="24" value={serviceEndHour} onChange={(e)=> setServiceEndHour(clamp(parseInt(e.target.value)||0,1,24))} className="ml-1 w-16 border border-slate-300 rounded px-1"/>:00</label>
                  </div>
                  <div className="mt-1 text-slate-600">Current service span: {Math.max(0, serviceEndHour - serviceStartHour)} hours/day</div>
                </div>

                <div className="flex gap-2 flex-wrap mt-1">
                  <button onClick={()=> setRunning(r=>!r)} className={`px-3 py-2 rounded-xl text-sm font-medium border ${running? 'bg-sky-100 border-sky-300':'bg-sky-500 text-white border-sky-600 hover:bg-sky-600'}`}>{running? 'Pause':'Play'}</button>
                  <button onClick={()=> { setStops([]); setCash(STARTING_CASH); setFleet(INITIAL_FLEET); setDepotCapacity(DEPOT_BASE_CAPACITY); setAvgBusAge(3); setDrivers(INITIAL_DRIVERS); setDayMinutes(0); setTotalMinutes(0); setDayVehHours(0); setEffSpeed(VEHICLE_SPEED_BASE); setPopulation(START_POP); setModeShare(0); setStreakDays(0); setGraduated(false); setTutorialStep(0); setServiceStartHour(DEFAULT_SERVICE_START_HOUR); setServiceEndHour(DEFAULT_SERVICE_END_HOUR); setPoiMap(generatePOIs(seed, START_POP)); }} className="px-3 py-2 rounded-xl text-sm font-medium border bg-white border-slate-300 hover:bg-slate-100">Reset</button>
                  <button onClick={()=> setSeed(s=> s+1)} className="px-3 py-2 rounded-xl text-sm font-medium border bg-white border-slate-300 hover:bg-slate-100">New Map</button>
                </div>
              </div>
            </div>
          </div>

          <footer className="mt-6 text-xs text-slate-500">Transit Simulator v0.8 • Desktop layout, status banners (10s, dismissible), mode-share progress bar, random POIs (retail/schools/tourism/airport), pop growth, staffing, per-boarding subsidy</footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>

  <style>
    @keyframes fadein { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</body>
</html>
