<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transit Simulator ‚Äî Baseline</title>
  <link rel="preconnect" href="https://unpkg.com">
  <style>
    :root{
      --topbar-h: 64px;
      --bezel-x: clamp(16px, 4vw, 56px);
      --col-gap: 24px;
      --left-w: 360px;
      --right-w: 360px;
      --card-bg: rgba(255,255,255,0.85);
      --card-br: 14px;
      --grid-border: #d9efe4;
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #eef8f3, #f4fbf7);
      color:#0f172a;
    }
    #topbar{
      min-height: var(--topbar-h);
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      padding: 0 var(--bezel-x);
      gap:12px;
      border-bottom:1px solid #e8f3ee;
      background: #f7fcfa;
      position: sticky; top:0; z-index: 10;
    }
    #topbarLeft{align-items:center; gap:12px; justify-self:start;}
    #topbarCenter{display:flex; justify-content:center; align-items:center; text-align:center; justify-self:center;}
    #topbarRight{display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:flex-end; justify-self:end;}
    @media (max-width: 768px){
      #topbar{grid-template-columns: 1fr; justify-items:center;}
      #topbarLeft,#topbarRight{justify-content:center; text-align:center;}
      #topbarCenter{order:-1;}
    }
    .app-title{font-size:20px; color:#0f172a; letter-spacing:0.02em;}
    .btn{height:32px; padding:0 10px; border:1px solid #cae9df; border-radius:10px; background:#fff; cursor:pointer;}
    .btn.active{background:#d1fae5; border-color:#34d399;}
    #viewport{height: calc(100vh - var(--topbar-h)); padding: 16px var(--bezel-x); overflow: hidden;}
    .grid3{display:grid; height:100%; gap: var(--col-gap); grid-template-columns: 1fr;}
    @media (min-width: 1024px){.grid3{grid-template-columns: var(--left-w) minmax(560px, 1fr) var(--right-w);}}
    .card{background: var(--card-bg); border: 1px solid #dff1ea; border-radius: var(--card-br); box-shadow: 0 2px 6px rgba(20,83,45,0.06);}
    .col{min-height:0; height:100%;}
    .col-scroll{overflow: auto;}
    .col-center{overflow: hidden; display:flex;}
    .center-card{display:flex; flex-direction:column; width:100%;}
    .center-head,.center-foot{padding:12px 14px; border-bottom:1px solid #e9f4ef;}
    .center-head{display:flex; flex-direction:column; gap:4px;}
    .center-foot{border-top:1px solid #e9f4ef; border-bottom:0;}
    .map-wrap{flex:1; display:grid; place-content:center; overflow:hidden;}
    #mapSquare{background:#f6fbf9; border:1px solid #e3f2ec; border-radius:12px; position:relative;}
    .gridLines{position:absolute; inset:0; background-image:linear-gradient(to right, var(--grid-border) 1px, transparent 1px),linear-gradient(to bottom, var(--grid-border) 1px, transparent 1px); background-size: 32px 32px; border-radius:12px; pointer-events:none;}
    .tile{position:absolute; transform: translate(-50%,-50%); font-size:18px;}
    .section{padding:14px; border-bottom:1px solid #e9f4ef;}
    .section:last-child{border-bottom:0;}
    .hstack{display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
    .stat{font-weight:700; color:#059669; font-size:28px;}
    .muted{color:#64748b; font-size:13px;}
    .demandHeat { position:absolute; inset:0; pointer-events:none; }
    .heatDot { position:absolute; width:10px; height:10px; border-radius:50%; background:rgba(239,68,68,0.22); transform:translate(-50%,-50%); filter:blur(4px); }
    .odLine { position:absolute; inset:0; pointer-events:none; }
    .odLine svg { overflow:visible; }
    .badge { display:inline-block; padding:2px 8px; border-radius:9999px; background:#fee2e2; color:#991b1b; font-size:12px; font-weight:600; }
    .routeItem { background:rgba(255,255,255,0.9); border:1px solid #d7ece3; border-radius:10px; padding:10px; margin-top:8px; cursor:pointer; transition:box-shadow 0.2s, border-color 0.2s; }
    .routeItem.active { border-color:#34d399; box-shadow:0 0 0 2px rgba(52,211,153,0.25); }
    .routeItem .routeTitle { display:flex; align-items:center; justify-content:space-between; font-weight:600; color:#0f172a; }
    .routeItem input[type="color"] { border:none; background:transparent; width:36px; height:24px; cursor:pointer; }
    .routeItem input[type="text"] { flex:1; min-width:120px; border:1px solid #d1e7dc; border-radius:6px; padding:4px 6px; font-size:13px; font-weight:600; color:#0f172a; background:#f9fffc; }
    .routeItem .routeMeta { display:flex; align-items:center; gap:10px; margin-top:8px; font-size:13px; color:#475569; flex-wrap:wrap; }
    .routeItem label { display:flex; align-items:center; gap:4px; font-size:12px; color:#475569; }
    .stopMarker { position:absolute; width:16px; height:16px; border-radius:50%; background:#059669; transform:translate(-50%,-50%); border:2px solid #ecfdf5; box-shadow:0 0 0 2px rgba(13,148,136,0.15); pointer-events:none; }
  </style>
</head>
<body>
  <header id="topbar">
    <div class="hstack" id="topbarLeft">
      <button class="btn" id="play">‚ñ∂ Play</button>
      <button class="btn spd" data-x="1">1√ó</button>
      <button class="btn spd" data-x="4">4√ó</button>
      <button class="btn spd" data-x="10">10√ó</button>
    </div>
    <div id="topbarCenter">
      <strong class="app-title">Transit Simulator</strong>
    </div>
    <div class="hstack" id="topbarRight">
      <button class="btn" id="jump">‚è≠ Jump</button>
      <button class="btn" id="settings">‚öô Settings</button>
      <button class="btn" id="reset">‚ü≤ Reset</button>
      <button class="btn" id="newmap">üó∫Ô∏è New Map</button>
    </div>
  </header>

  <main id="viewport">
    <div class="grid3">
      <aside class="col col-scroll card" id="leftCol">
        <div class="section"><div class="muted">Cash</div><div class="stat" id="cash">$5,000,000</div></div>
        <div class="section"><div class="muted">Riders / hr</div><div id="rph">0</div></div>
        <div class="section"><div class="muted">Vehicles in use</div><div id="veh">0 / 10 (Spare: 10)</div></div>
        <div class="section"><div class="muted">Daily money</div><div id="money">$0 ‚Äì $0 = $0</div></div>
        <div class="section">
          <div class="muted">Potential trips / day</div>
          <div id="potentialTrips">‚Äî</div>
        </div>
      </aside>

      <section class="col col-center card" id="centerCol">
        <div class="center-card">
          <div class="center-head">
            <div class="muted" id="clock">Day 1 ¬∑ 06:00 ‚Äî In service (paused)</div>
            <div class="muted">Tutorial City ¬∑ Population 100,000 ¬∑ Goal: 5% for 30 days</div>
          </div>
          <div class="map-wrap"><div id="mapSquare"><div class="gridLines"></div></div></div>
          <div class="center-foot muted">Select a route to begin placing stops. Shift-click tiles to remove stops from the active route.</div>
        </div>
      </section>

      <aside class="col col-scroll card" id="rightCol">
        <div class="section" id="routesPanel">
          <div class="hstack" style="justify-content:space-between;">
            <strong>Routes</strong>
            <button class="btn" id="addRoute">Ôºã Route</button>
          </div>
          <div id="routeList" class="muted" style="margin-top:8px;">No routes yet. Add one to begin planning.</div>
          <div id="routeDetails" class="muted" style="margin-top:12px;">
            Select a route to edit its color, vehicles, and stops.
          </div>
        </div>
        <div class="section"><strong>Fare &amp; Policy</strong><div class="hstack"><button class="btn" id="fareMinus">‚Äì</button><div id="fare">$2.00</div><button class="btn" id="farePlus">+</button></div><div class="muted">Range: $1.50 ‚Äì $3.00</div></div>
        <div class="section"><strong>Service Hours</strong><div class="muted">Start 06:00 ¬∑ End 22:00</div></div>
        <div class="section">
          <strong>Demand</strong>
          <div class="hstack" style="margin-top:6px;">
            <label class="hstack">
              <input id="toggleDemandHeat" type="checkbox" />
              <span class="muted">Show demand heat</span>
            </label>
            <label class="hstack">
              <input id="toggleInspector" type="checkbox" />
              <span class="muted">Demand inspector</span>
            </label>
          </div>
          <div class="muted" id="demandSummary" style="margin-top:6px;">Potential trips/day: ‚Äî</div>
        </div>
      </aside>
    </div>
  </main>

  <script>
  const $ = s=>document.querySelector(s), $$ = s=>[...document.querySelectorAll(s)];
  const rand=n=>Math.floor(Math.random()*n);

  // --- CONFIG (tweak later)
  const GRID=20;          // tiles per side
  const HOMES=60;         // number of homes emoji
  const POIS=24;          // number of POIs emoji
  const POI_TYPES=['üõçÔ∏è','üè´','üé°','üè•','üè¢','üçî'];
  const ATTR = {         // attractiveness by type (rough)
    'üõçÔ∏è':1.2,'üè´':1.0,'üé°':0.8,'üè•':0.6,'üè¢':0.9,'üçî':0.7
  };
  const DIST_DECAY=0.06;  // higher ‚Üí fewer long trips
  const TRIPS_PER_HOME=8; // target avg daily trips per home (both ways counted as 2)
  const MAX_VEHICLES=10;  // garage capacity
  const KM_PER_TILE=0.4;  // rough size of one tile in km
  const AVG_SPEED_KPH=22; // average operating speed
  const DWELL_PER_STOP_MIN=0.5; // dwell time per stop in minutes
  const TARGET_HEADWAY_MIN=10;  // target headway passengers expect
  const MIN_LOOP_MINUTES=5;     // minimum practical loop cycle
  const MINUTES_PER_DAY=24*60;
  const SERVICE_START=6*60;
  const SERVICE_END=22*60;
  const VEHICLE_COST_PER_HOUR=95;
  const BASE_CASH=5_000_000;
  const FARE_MIN=1.5;
  const FARE_MAX=3.0;
  const FARE_STEP=0.05;
  const DEFAULT_FARE=2.0;

  let simMinute=SERVICE_START;
  let simDay=1;
  let simRunning=false;
  let simTimer=null;
  let simSpeed=1;
  let cash=BASE_CASH;
  let fare=DEFAULT_FARE;
  let ridersToday=0;
  let revenueToday=0;
  let expensesToday=0;
  let lastRidershipHr=0;
  let lastVehiclesUsed=0;

  // --- MAP SIZING (square fits viewport)
  function sizeMap(){
    const map=$("#mapSquare"),wrap=$("#centerCol .map-wrap");
    const avail=Math.min(wrap.clientWidth,wrap.clientHeight);
    const cell=Math.max(16, Math.floor(avail/GRID)), size=cell*GRID;
    map.style.width=size+"px"; map.style.height=size+"px";
    map.querySelector(".gridLines").style.backgroundSize=cell+"px "+cell+"px";
    map.dataset.cell=cell;
    repositionStops();
  }

  // --- STATE
  let homes=[], pois=[];
  let od=[]; // list of {ox,oy,dx,dy,tripsPerDay,type,dist}
  let inspectorOn=false, heatOn=false;
  let stops=new Map(); // key "x,y" -> {id,x,y,el,usage}
  let routes=[]; // list of {id,name,color,vehicles,stops:[],ridership}
  let editingRouteId=null;
  let routeSeq=1;

  // --- helpers
  function addTile(emoji,gx,gy,scale=1){
    const map=$("#mapSquare");
    const cell=parseInt(map.dataset.cell||"24",10);
    const d=document.createElement("div");
    d.className="tile";
    d.style.left=(gx*cell+cell/2)+"px";
    d.style.top=(gy*cell+cell/2)+"px";
    d.style.fontSize=Math.round(16*scale)+"px";
    d.textContent=emoji;
    d.dataset.gx=gx; d.dataset.gy=gy; d.dataset.emoji=emoji;
    map.appendChild(d);
    return d;
  }
  function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }

  function stopKey(gx,gy){ return `${gx},${gy}`; }

  function clamp(min,max,value){
    return Math.min(max, Math.max(min, value));
  }

  function stopIdToCoords(stopId){
    if(!stopId) return null;
    const key=stopId.startsWith('s') ? stopId.slice(1) : stopId;
    const stop=stops.get(key);
    if(!stop) return null;
    return {x:stop.x, y:stop.y};
  }

  function routeStopCoords(route){
    if(!route) return [];
    const coords=[];
    const seen=new Set();
    for(const stopId of route.stops){
      if(seen.has(stopId)) continue;
      const c=stopIdToCoords(stopId);
      if(c){ coords.push(c); seen.add(stopId); }
    }
    return coords;
  }

  function computeLoopMinutes(route){
    const coords=routeStopCoords(route);
    if(coords.length<2){
      return Math.max(MIN_LOOP_MINUTES, coords.length * DWELL_PER_STOP_MIN || MIN_LOOP_MINUTES);
    }
    let tileDistance=0;
    for(let i=0;i<coords.length;i++){
      const a=coords[i];
      const b=coords[(i+1)%coords.length];
      tileDistance+=Math.hypot(a.x-b.x, a.y-b.y);
    }
    const travelKm=tileDistance*KM_PER_TILE;
    const travelMinutes=(travelKm/AVG_SPEED_KPH)*60;
    const dwellMinutes=coords.length*DWELL_PER_STOP_MIN;
    return Math.max(MIN_LOOP_MINUTES, travelMinutes+dwellMinutes);
  }

  function escapeHTML(str){
    return (str??'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]||c));
  }

  function ensureStop(gx,gy){
    const key=stopKey(gx,gy);
    if(stops.has(key)) return stops.get(key);
    const cell=parseInt($("#mapSquare").dataset.cell||"24",10);
    const marker=document.createElement("div");
    marker.className="stopMarker";
    marker.style.left=(gx*cell+cell/2)+"px";
    marker.style.top =(gy*cell+cell/2)+"px";
    $("#mapSquare").appendChild(marker);
    const stop={id:`s${key}`,x:gx,y:gy,el:marker,usage:0};
    stops.set(key,stop);
    return stop;
  }

  function removeStopMarkerIfUnused(stop){
    if(stop.usage<=0){
      if(stop.el && stop.el.parentNode) stop.el.parentNode.removeChild(stop.el);
      stops.delete(stopKey(stop.x,stop.y));
    }
  }

  function resetAllStops(){
    stops.forEach(s=>{ if(s.el && s.el.parentNode) s.el.parentNode.removeChild(s.el); });
    stops.clear();
  }

  function repositionStops(){
    const cell=parseInt($("#mapSquare").dataset.cell||"24",10);
    stops.forEach(stop=>{
      stop.el.style.left=(stop.x*cell+cell/2)+"px";
      stop.el.style.top =(stop.y*cell+cell/2)+"px";
    });
  }

  function resetRoutes(){
    routes.length=0;
    editingRouteId=null;
    routeSeq=1;
    resetAllStops();
    renderRoutesPanel();
    updateRouteStats();
    updateRouteDetails();
    updateEditingStatus();
  }

  function makeRoute(){
    const id=`r${routeSeq++}`;
    const colors=['#1d4ed8','#dc2626','#047857','#9333ea','#f59e0b','#0891b2'];
    const color=colors[(routes.length)%colors.length];
    const route={id,name:`Route ${routes.length+1}`,color,vehicles:1,stops:[],ridership:0,loopMinutes:MIN_LOOP_MINUTES,headway:Infinity,servedTripsPerDay:0};
    routes.push(route);
    selectRoute(id);
    renderRoutesPanel();
    updateRouteStats();
    return route;
  }

  function selectRoute(id){
    editingRouteId=id;
    if(inspectorLayer) inspectorLayer.innerHTML="";
    renderRoutesPanel();
    updateRouteDetails();
    updateEditingStatus();
  }

  function routeStopCount(route){
    return route ? route.stops.length : 0;
  }

  function updateRouteMetrics(route){
    const coords=routeStopCoords(route);
    const loopMinutes=computeLoopMinutes(route);
    const vehicles=Math.max(0, Number(route.vehicles)||0);
    const headway=vehicles>0 ? loopMinutes/vehicles : Infinity;
    route.loopMinutes=loopMinutes;
    route.headway=headway;

    if(coords.length<2){
      route.ridership=0;
      route.servedTripsPerDay=0;
      return;
    }

    const coverageRadius=1.01;
    let servedTrips=0;
    for(const trip of od){
      const originServed=coords.some(c=>Math.hypot(c.x-trip.ox, c.y-trip.oy)<=coverageRadius);
      if(!originServed) continue;
      const destServed=coords.some(c=>Math.hypot(c.x-trip.dx, c.y-trip.dy)<=coverageRadius);
      if(!destServed) continue;
      servedTrips+=trip.tripsPerDay;
    }

    route.servedTripsPerDay=servedTrips;

    const serviceHours=Math.max(1, (SERVICE_END-SERVICE_START)/60);
    const hourlyDemand=servedTrips/serviceHours;
    if(!servedTrips || !isFinite(headway) || vehicles<=0){
      route.ridership=0;
      return;
    }

    const effectiveHeadway=Math.max(headway, 0.1);
    const waitFactor=clamp(0,1, TARGET_HEADWAY_MIN/effectiveHeadway);
    route.ridership=Math.round(hourlyDemand*waitFactor);
  }

  function updateRouteStats(){
    let vehiclesUsed=0, ridershipHr=0;
    for(const route of routes){
      updateRouteMetrics(route);
      vehiclesUsed+=route.vehicles;
      ridershipHr+=route.ridership;
    }
    lastVehiclesUsed=vehiclesUsed;
    lastRidershipHr=ridershipHr;
    const spare=Math.max(0, MAX_VEHICLES-vehiclesUsed);
    const vehLabel=$("#veh");
    if(vehLabel){ vehLabel.textContent=`${vehiclesUsed} / ${MAX_VEHICLES} (Spare: ${spare})`; }
    const rph=$("#rph");
    if(rph){ rph.textContent=ridershipHr.toLocaleString(); }
  }

  function updateRouteDetails(){
    const details=$("#routeDetails");
    if(!details) return;
    const route=routes.find(r=>r.id===editingRouteId);
    if(!route){
      details.innerHTML='Select a route to edit its color, vehicles, and stops.';
      return;
    }
    const uniqueStops=new Set(route.stops).size;
    const safeName=escapeHTML(route.name||'');
    const loopLabel = route.loopMinutes ? route.loopMinutes.toFixed(1) : '‚Äî';
    const headwayLabel = (route.vehicles>0 && isFinite(route.headway)) ? `${route.headway.toFixed(1)} min` : 'No service';
    details.innerHTML=`<div><strong>${safeName}</strong></div>
      <div>Stops placed: ${route.stops.length} (${uniqueStops} unique)</div>
      <div>Vehicles assigned: ${route.vehicles}</div>
      <div>Loop time: ${loopLabel} min ¬∑ Headway: ${headwayLabel}</div>
      <div>Estimated riders / hr (frequency-adjusted): ${route.ridership.toLocaleString()}</div>
      <div style="margin-top:6px;">Click the map to add stops. Shift-click to remove the stop for this tile.</div>`;
  }

  function updateEditingStatus(){
    const foot=$(".center-foot");
    if(!foot) return;
    const route=routes.find(r=>r.id===editingRouteId);
    if(route){
      foot.textContent=`Editing ${route.name}: click the map to add stops ¬∑ Shift-click to remove.`;
    }else if(inspectorOn){
      foot.textContent='Demand inspector active: click a home to view its top destinations.';
    }else{
      foot.textContent='Select a route to begin placing stops. Shift-click tiles to remove stops from the active route.';
    }
  }

  function renderRoutesPanel(){
    const list=$("#routeList");
    if(!list) return;
    list.innerHTML="";
    if(!routes.length){
      list.textContent='No routes yet. Add one to begin planning.';
      list.classList.add('muted');
      return;
    }
    list.classList.remove('muted');
    for(const route of routes){
      const item=document.createElement("div");
      item.className="routeItem"+(route.id===editingRouteId?" active":"");
      item.dataset.route=route.id;
      item.style.borderLeft=`6px solid ${route.color}`;
      item.style.paddingLeft="12px";

      const title=document.createElement("div");
      title.className="routeTitle";

      const nameInput=document.createElement("input");
      nameInput.type="text";
      nameInput.value=route.name;
      nameInput.addEventListener("click",e=>e.stopPropagation());
      nameInput.addEventListener("input",e=>{ route.name=e.target.value; updateRouteDetails(); updateEditingStatus(); });
      nameInput.addEventListener("blur",()=>{
        if(!route.name || !route.name.trim()){
          const fallbackIndex=routes.indexOf(route)+1;
          route.name=`Route ${fallbackIndex}`;
          nameInput.value=route.name;
          updateRouteDetails();
          updateEditingStatus();
        }
      });

      const colorInput=document.createElement("input");
      colorInput.type="color";
      colorInput.value=route.color;
      colorInput.addEventListener("click",e=>e.stopPropagation());
      colorInput.addEventListener("input",e=>{ route.color=e.target.value; updateRouteDetails(); renderRoutesPanel(); });

      title.appendChild(nameInput);
      title.appendChild(colorInput);
      item.appendChild(title);

      const meta=document.createElement("div");
      meta.className="routeMeta";

      const stopsSpan=document.createElement("span");
      stopsSpan.textContent=`Stops: ${routeStopCount(route)}`;

      const ridersSpan=document.createElement("span");
      ridersSpan.textContent=`Riders/hr*: ${route.ridership.toLocaleString()}`;
      ridersSpan.title='Ridership scales with headway ‚Äî assign more vehicles for higher frequency.';

      const headwaySpan=document.createElement("span");
      headwaySpan.textContent=route.vehicles>0 && isFinite(route.headway)
        ? `Headway: ${route.headway.toFixed(1)} min`
        : 'Headway: No service';

      const vehiclesLabel=document.createElement("label");
      vehiclesLabel.textContent="Vehicles";
      const vehiclesInput=document.createElement("input");
      vehiclesInput.type="number";
      vehiclesInput.min="0";
      vehiclesInput.max=String(MAX_VEHICLES);
      vehiclesInput.value=route.vehicles;
      vehiclesInput.style.width="56px";
      vehiclesInput.addEventListener("click",e=>e.stopPropagation());
      vehiclesInput.addEventListener("change",e=>{
        const v=Math.max(0, Math.min(MAX_VEHICLES, parseInt(e.target.value||"0",10)));
        route.vehicles=v;
        vehiclesInput.value=v;
        updateRouteStats();
        updateRouteDetails();
        renderRoutesPanel();
      });
      vehiclesLabel.appendChild(vehiclesInput);

      meta.appendChild(stopsSpan);
      meta.appendChild(ridersSpan);
      meta.appendChild(headwaySpan);
      meta.appendChild(vehiclesLabel);
      item.appendChild(meta);

      item.addEventListener("click",()=>{ selectRoute(route.id); });

      list.appendChild(item);
    }
  }

  function addStopToRoute(route,gx,gy){
    const stop=ensureStop(gx,gy);
    if(route.stops.includes(stop.id)){
      return;
    }
    route.stops.push(stop.id);
    stop.usage=(stop.usage||0)+1;
    updateRouteMetrics(route);
    updateRouteStats();
    updateRouteDetails();
    renderRoutesPanel();
  }

  function removeStopFromRoute(route,gx,gy){
    const key=stopKey(gx,gy);
    const stop=stops.get(key);
    if(!stop) return;
    const idx=route.stops.lastIndexOf(stop.id);
    if(idx>-1){
      route.stops.splice(idx,1);
      stop.usage=Math.max(0,(stop.usage||0)-1);
      removeStopMarkerIfUnused(stop);
      updateRouteMetrics(route);
      updateRouteStats();
      updateRouteDetails();
      renderRoutesPanel();
    }
  }

  function handleStopEdit(e){
    const route=routes.find(r=>r.id===editingRouteId);
    if(!route) return;
    const map=$("#mapSquare");
    const rect=map.getBoundingClientRect();
    const cell=parseInt(map.dataset.cell||"24",10);
    const mx=e.clientX-rect.left;
    const my=e.clientY-rect.top;
    const gx=Math.max(0, Math.min(GRID-1, Math.floor(mx/cell)));
    const gy=Math.max(0, Math.min(GRID-1, Math.floor(my/cell)));
    if(e.shiftKey){
      removeStopFromRoute(route,gx,gy);
    }else{
      addStopToRoute(route,gx,gy);
    }
  }

  function mapClickRouter(e){
    if(editingRouteId){
      handleStopEdit(e);
      return;
    }
    if(inspectorOn){
      handleInspectorClick(e);
    }
  }

  // --- city generation: homes + destinations
  function generateCity(){
    homes=[]; pois=[];
    const map=$("#mapSquare");
    // clear old emoji tiles (keep grid & overlays)
    [...map.querySelectorAll(".tile")].forEach(n=>n.remove());
    // simple clustered homes (near middle-ish)
    for(let i=0;i<HOMES;i++){
      const gx=Math.min(GRID-1, Math.max(0, rand(GRID) + (rand(3)-1)));
      const gy=Math.min(GRID-1, Math.max(0, rand(GRID) + (rand(3)-1)));
      const el=addTile('üè†',gx,gy,1+Math.random()*0.3);
      homes.push({x:gx,y:gy,el});
    }
    for(let i=0;i<POIS;i++){
      const t=POI_TYPES[rand(POI_TYPES.length)];
      const gx=rand(GRID), gy=rand(GRID);
      const el=addTile(t,gx,gy,1.1);
      pois.push({x:gx,y:gy,el,type:t,attr:ATTR[t]||1});
    }
  }

  // --- OD generation: for each home, allocate daily trips to top-K nearby POIs by gravity model
  function buildOD(){
    od.length=0;
    let total=0;
    for(const h of homes){
      // score each POI by attractiveness * f(distance)
      const scored=pois.map(p=>{
        const d=dist(h,p);
        const w=p.attr * Math.exp(-DIST_DECAY*d);
        return {p,w,d};
      }).filter(r=>r.w>0.01).sort((a,b)=>b.w-a.w);

      // take top 6 targets, normalize to daily trips
      const top=scored.slice(0,6);
      const sumW=top.reduce((s,r)=>s+r.w,0)||1;
      for(const r of top){
        const share=r.w/sumW;
        const trips=Math.max(0, Math.round(TRIPS_PER_HOME*share));
        if(trips>0){
          od.push({ox:h.x,oy:h.y,dx:r.p.x,dy:r.p.y,tripsPerDay:trips,type:r.p.type,dist:r.d});
          total+=trips;
        }
      }
    }
    $("#demandSummary").textContent=`Potential trips/day: ${total.toLocaleString()}`;
    $("#potentialTrips") && ($("#potentialTrips").textContent = total.toLocaleString());
    updateRouteStats();
    renderRoutesPanel();
    updateRouteDetails();
  }

  // --- Demand Heat overlay
  function renderHeat(){
    const map=$("#mapSquare");
    let layer=map.querySelector(".demandHeat");
    if(!layer){ layer=document.createElement("div"); layer.className="demandHeat"; map.appendChild(layer); }
    layer.innerHTML="";
    if(!heatOn) return;
    const cell=parseInt(map.dataset.cell||"24",10);
    // intensity per origin
    const byOrigin = new Map();
    for(const t of od){
      const key=t.ox+","+t.oy;
      byOrigin.set(key,(byOrigin.get(key)||0)+t.tripsPerDay);
    }
    // scale dots
    const vals=[...byOrigin.values()];
    const max=Math.max(1, ...vals);
    for(const [key,v] of byOrigin.entries()){
      const [gx,gy]=key.split(",").map(Number);
      const dot=document.createElement("div");
      dot.className="heatDot";
      dot.style.left=(gx*cell+cell/2)+"px";
      dot.style.top =(gy*cell+cell/2)+"px";
      const alpha = 0.18 + 0.30*(v/max);
      dot.style.background=`rgba(239,68,68,${alpha.toFixed(2)})`;
      dot.style.width = (10 + 14*(v/max))+"px";
      dot.style.height= (10 + 14*(v/max))+"px";
      layer.appendChild(dot);
    }
  }

  // --- Demand Inspector: click a üè† to draw its OD lines to top destinations
  let inspectorLayer;
  function enableInspectorHandlers(){
    const map=$("#mapSquare");
    if(!inspectorLayer){
      inspectorLayer=document.createElement("div");
      inspectorLayer.className="odLine";
      map.appendChild(inspectorLayer);
    }
    updateEditingStatus();
  }
  function disableInspectorHandlers(){
    if(inspectorLayer) inspectorLayer.innerHTML="";
    updateEditingStatus();
  }
  function handleInspectorClick(e){
    // only react if clicked near a home
    const cell=parseInt($("#mapSquare").dataset.cell||"24",10);
    const rect=$("#mapSquare").getBoundingClientRect();
    const mx=e.clientX-rect.left, my=e.clientY-rect.top;
    const gx=Math.floor(mx/cell), gy=Math.floor(my/cell);
    // find nearest home within 1 cell
    let nearest=null, best=1e9;
    for(const h of homes){
      const d=Math.hypot(h.x-gx, h.y-gy);
      if(d<best){best=d; nearest=h;}
    }
    if(!nearest || best>1.1){ // not a home
      if(inspectorLayer) inspectorLayer.innerHTML="";
      return;
    }
    // draw lines for this home
    const list=od.filter(t=>t.ox===nearest.x && t.oy===nearest.y).sort((a,b)=>b.tripsPerDay-a.tripsPerDay).slice(0,6);
    drawODLines(list);
  }
  function drawODLines(list){
    if(!inspectorLayer) return;
    inspectorLayer.innerHTML="";
    const cell=parseInt($("#mapSquare").dataset.cell||"24",10);
    for(const t of list){
      const x1=t.ox*cell+cell/2, y1=t.oy*cell+cell/2;
      const x2=t.dx*cell+cell/2, y2=t.dy*cell+cell/2;
      const w = Math.max(1, Math.round(1 + t.tripsPerDay/6));
      const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
      svg.setAttribute("style","position:absolute; left:0; top:0; width:100%; height:100%;");
      const path = document.createElementNS("http://www.w3.org/2000/svg","polyline");
      // Route orthogonally to better match the grid aesthetic
      const viaX = Math.abs(x2 - x1) > Math.abs(y2 - y1) ? x2 : x1;
      const viaY = viaX === x2 ? y1 : y2;
      const points = `${x1},${y1} ${viaX},${viaY} ${x2},${y2}`;
      path.setAttribute("points", points);
      path.setAttribute("fill", "none");
      path.setAttribute("stroke","rgba(220,38,38,0.6)");
      path.setAttribute("stroke-width",w);
      path.setAttribute("stroke-linecap","round");
      path.setAttribute("stroke-linejoin","round");
      svg.appendChild(path);
      inspectorLayer.appendChild(svg);
    }
  }

  // --- init & resize
  function rebuildAll(){
    sizeMap();
    resetRoutes();
    generateCity();
    buildOD();
    renderHeat();
  }

  function formatMoney(value){
    const sign=value<0?"-":"";
    const abs=Math.abs(value);
    return `${sign}$${abs.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}`;
  }

  function updateFinanceUI(){
    const cashEl=$("#cash");
    if(cashEl){ cashEl.textContent=formatMoney(cash); }
    const money=$("#money");
    if(money){
      const net=revenueToday-expensesToday;
      money.textContent=`${formatMoney(revenueToday)} ‚Äì ${formatMoney(expensesToday)} = ${formatMoney(net)}`;
    }
  }

  function formatTime(minute){
    const h=Math.floor(minute/60)%24;
    const m=minute%60;
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
  }

  function serviceStatus(){
    let base;
    if(simMinute < SERVICE_START) base="Before service";
    else if(simMinute >= SERVICE_END) base="After service";
    else base="In service";
    if(!simRunning && simMinute>=SERVICE_START && simMinute<SERVICE_END) base+=" (paused)";
    return base;
  }

  function updateClockLabel(){
    const clock=$("#clock");
    if(clock){
      clock.textContent=`Day ${simDay} ¬∑ ${formatTime(simMinute)} ‚Äî ${serviceStatus()}`;
    }
  }

  function resetDailyTallies(){
    ridersToday=0;
    revenueToday=0;
    expensesToday=0;
    updateFinanceUI();
  }

  function updatePlayButton(){
    const btn=$("#play");
    if(btn){ btn.textContent=simRunning?"‚è∏ Pause":"‚ñ∂ Play"; }
  }

  function updateSpeedButtons(){
    $$(".spd").forEach(btn=>{
      const mult=parseInt(btn.dataset.x||"1",10);
      if(mult===simSpeed) btn.classList.add("active");
      else btn.classList.remove("active");
    });
  }

  function stopSimTimer(){
    if(simTimer){ clearInterval(simTimer); simTimer=null; }
  }

  function setSimRunning(next){
    if(simRunning===next) return;
    simRunning=next;
    updatePlayButton();
    updateClockLabel();
    if(simRunning){
      stopSimTimer();
      simTimer=setInterval(()=>advanceSim(simSpeed), 400);
    }else{
      stopSimTimer();
    }
  }

  function setSpeed(mult){
    simSpeed=mult;
    updateSpeedButtons();
  }

  function stepMinute(){
    const inService = simMinute>=SERVICE_START && simMinute<SERVICE_END;
    const ridersPerMinute = inService ? lastRidershipHr/60 : 0;
    const revenue = ridersPerMinute * fare;
    const expenses = inService ? (lastVehiclesUsed * VEHICLE_COST_PER_HOUR)/60 : 0;
    ridersToday += ridersPerMinute;
    revenueToday = Math.round((revenueToday + revenue)*100)/100;
    expensesToday = Math.round((expensesToday + expenses)*100)/100;
    cash = Math.round((cash + revenue - expenses)*100)/100;

    simMinute++;
    if(simMinute>=MINUTES_PER_DAY){
      simMinute=0;
      simDay++;
      resetDailyTallies();
    }
  }

  function advanceSim(minutes){
    for(let i=0;i<minutes;i++){
      stepMinute();
    }
    updateClockLabel();
    updateFinanceUI();
  }

  function resetSimulationState(){
    stopSimTimer();
    simRunning=false;
    simDay=1;
    simMinute=SERVICE_START;
    cash=BASE_CASH;
    fare=DEFAULT_FARE;
    simSpeed=1;
    resetDailyTallies();
    updateFareDisplay();
    updatePlayButton();
    updateSpeedButtons();
    updateClockLabel();
  }

  function jumpToServiceStart(){
    setSimRunning(false);
    if(simMinute >= SERVICE_START){
      simDay++;
      resetDailyTallies();
    }
    simMinute=SERVICE_START;
    updateClockLabel();
    updateFinanceUI();
  }

  function updateFareDisplay(){
    const fareLabel=$("#fare");
    if(fareLabel){ fareLabel.textContent=`$${fare.toFixed(2)}`; }
  }

  function setFare(value){
    const clamped=Math.min(FARE_MAX, Math.max(FARE_MIN, Math.round(value*100)/100));
    fare=clamped;
    updateFareDisplay();
  }

  function init(){
    rebuildAll();
    resetSimulationState();

    // controls
    $("#fareMinus").onclick=()=>{ setFare(fare-FARE_STEP); };
    $("#farePlus").onclick=()=>{ setFare(fare+FARE_STEP); };
    window.addEventListener("resize",()=>{ sizeMap(); renderHeat(); /* positions persist */ });

    $("#mapSquare").addEventListener("click", mapClickRouter);
    $("#addRoute").addEventListener("click", ()=>{
      makeRoute();
      updateEditingStatus();
    });

    // Demand toggles
    $("#toggleDemandHeat").addEventListener("change",(e)=>{ heatOn=e.target.checked; renderHeat(); });
    $("#toggleInspector").addEventListener("change",(e)=>{ inspectorOn=e.target.checked; if(inspectorOn) enableInspectorHandlers(); else disableInspectorHandlers(); });

    // speed controls
    $$(".spd").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const mult=parseInt(btn.dataset.x||"1",10);
        setSpeed(mult);
      });
    });

    $("#play").addEventListener("click", ()=>{ setSimRunning(!simRunning); });
    $("#jump").addEventListener("click", ()=>{ jumpToServiceStart(); });
    $("#newmap").addEventListener("click", ()=>{ setSimRunning(false); rebuildAll(); resetSimulationState(); });
    $("#reset").addEventListener("click", ()=>{ setSimRunning(false); rebuildAll(); resetSimulationState(); });
  }

  window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
